{{ define "page" }}
  <div class="container mt-2">

    <!-- Filters -->
    <div class="card mb-3">
      <div class="card-header">
        <h5>Filters</h5>
      </div>
      <div class="card-body">
        <form method="GET" class="row g-3">
          <div class="col-md-3">
            <label for="user_email" class="form-label">User Email</label>
            <input type="email" class="form-control" id="user_email" name="user_email" value="{{ .Filters.UserEmail }}">
          </div>
          <div class="col-md-3">
            <label for="action_type" class="form-label">Action Type</label>
            <select class="form-control" id="action_type" name="action_type">
              <option value="">All Actions</option>
              {{ range $action, $count := .Stats.LogsByActionType }}
                <option value="{{ $action }}" {{ if eq $action $.Filters.ActionType }}selected{{ end }}>
                  {{ $action }} ({{ $count }})
                </option>
              {{ end }}
            </select>
          </div>
          <div class="col-md-3">
            <label for="entity_type" class="form-label">Entity Type</label>
            <select class="form-control" id="entity_type" name="entity_type">
              <option value="">All Entities</option>
              {{ range $entity, $count := .Stats.LogsByEntityType }}
                <option value="{{ $entity }}" {{ if eq $entity $.Filters.EntityType }}selected{{ end }}>
                  {{ $entity }} ({{ $count }})
                </option>
              {{ end }}
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary me-2">Filter</button>
            <a href="/audit" class="btn btn-secondary">Clear</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Audit Logs Table -->
    <div class="card">
      <div class="card-body px-0 py-3">
        <h2 class="px-2">Audit Logs</h2>
        <div class="table-responsive px-0 py-1">
          <table class="table table-nobr" id="audit-logs">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Action</th>
                <th>Entity</th>
                <th>Entity Name</th>
                <th>Changes</th>
              </tr>
            </thead>
            <tbody>
              {{ range $log := .Logs }}
                <tr>
                  <td>
                    <span title="{{ $log.Timestamp.Format "2006-01-02 15:04:05 UTC" }}">
                      {{ $log.Timestamp.Format "Jan 2, 15:04" }}
                    </span>
                  </td>
                  <td>{{ $log.UserEmail }}</td>
                  <td>
                    {{ if eq $log.ActionType "spammer_create" }}
                      Create Spammer
                    {{ else if eq $log.ActionType "spammer_update" }}
                      Update Spammer
                    {{ else if eq $log.ActionType "spammer_delete" }}
                      Delete Spammer
                    {{ else if eq $log.ActionType "spammer_start" }}
                      Start Spammer
                    {{ else if eq $log.ActionType "spammer_pause" }}
                      Stop Spammer
                    {{ else if eq $log.ActionType "spammer_reclaim" }}
                      Reclaim Spammer Funds
                    {{ else if eq $log.ActionType "client_update" }}
                      Update Client
                    {{ else if eq $log.ActionType "client_group_update" }}
                      Update Client Group
                    {{ else if eq $log.ActionType "client_name_update" }}
                      Change Client Name
                    {{ else if eq $log.ActionType "client_type_update" }}
                      Change Client Type
                    {{ else if eq $log.ActionType "client_toggle" }}
                      {{ $toggleMetadata := UnmarshalAuditMetadata $log.Metadata }}
                      {{ if and $toggleMetadata (index $toggleMetadata "enabled") }}
                        {{ if eq (index $toggleMetadata "enabled") true }}
                          Enable Client
                        {{ else }}
                          Disable Client
                        {{ end }}
                      {{ else }}
                        Toggle Client
                      {{ end }}
                    {{ else if eq $log.ActionType "spammers_import" }}
                      Import Spammers
                    {{ else if eq $log.ActionType "spammers_export" }}
                      Export Spammers
                    {{ else }}
                      {{ $log.ActionType }}
                    {{ end }}
                  </td>
                  <td>
                    {{ if eq $log.EntityType "spammer" }}
                      <i class="fas fa-robot me-1"></i>Spammer #{{ $log.EntityID }}
                    {{ else if eq $log.EntityType "client" }}
                      <i class="fas fa-server me-1"></i>Client
                    {{ else }}
                      <i class="fas fa-cog me-1"></i>{{ $log.EntityType }}
                    {{ end }}
                  </td>
                  <td>{{ $log.EntityName }}</td>
                  <td>
                    {{ if $log.Diff }}
                      {{ $metadata := UnmarshalAuditMetadata $log.Metadata }}
                      {{ if and $metadata (index $metadata "single_property_change") }}
                        {{ $propertyName := index $metadata "property_name" }}
                        <!-- Only show simple display for simple properties, not config changes -->
                        {{ if and (ne $propertyName "config") (ne $propertyName "configuration") }}
                          <!-- Simple property change display -->
                          {{ $oldValue := index $metadata "old_value" }}
                          {{ $newValue := index $metadata "new_value" }}
                          <div class="small text-muted">
                            <strong>{{ $propertyName }}:</strong> 
                            <span class="text-decoration-line-through">{{ $oldValue }}</span> 
                            <i class="fas fa-arrow-right mx-1"></i> 
                            <span class="text-success">{{ $newValue }}</span>
                          </div>
                        {{ else }}
                          <!-- Config changes always show full diff -->
                          <button class="btn btn-sm btn-outline-info" type="button" 
                                  data-bs-toggle="collapse" 
                                  data-bs-target="#diff-{{ $log.ID }}" 
                                  aria-expanded="false">
                            <i class="fas fa-code"></i> View Changes
                          </button>
                          <div class="collapse mt-2" id="diff-{{ $log.ID }}">
                            <div class="card card-body">
                              <pre class="mb-0" style="font-size: 0.8rem; white-space: pre;">{{ $log.Diff }}</pre>
                            </div>
                          </div>
                        {{ end }}
                      {{ else }}
                        <!-- Full diff display -->
                        <button class="btn btn-sm btn-outline-info" type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#diff-{{ $log.ID }}" 
                                aria-expanded="false">
                          <i class="fas fa-code"></i> View Changes
                        </button>
                        <div class="collapse mt-2" id="diff-{{ $log.ID }}">
                          <div class="card card-body">
                            <pre class="mb-0" style="font-size: 0.8rem; white-space: pre;">{{ $log.Diff }}</pre>
                          </div>
                        </div>
                      {{ end }}
                    {{ else }}
                      <span class="text-muted">No changes</span>
                    {{ end }}
                  </td>
                </tr>
              {{ end }}
              {{ if not .Logs }}
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    No audit logs found
                  </td>
                </tr>
              {{ end }}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{{ end }}

{{ define "css" }}
{{ end }}

{{ define "js" }}
<script>
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
</script>
{{ end }}